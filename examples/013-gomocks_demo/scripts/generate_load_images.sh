#!/usr/bin/env bash

set -euo pipefail

echo "Generating images.bzl file..."

cd $BUILD_WORKSPACE_DIRECTORY

# Define the images.bzl file
IMAGES_FILE="$BUILD_WORKSPACE_DIRECTORY/images.bzl"

# Run Bazel query, sort, and format in one pipeline
FORMATTED_TARGETS=$(bazel query "kind(oci_load, //...)" | sort | awk '{print "    \"" $0 "\","}')

# Check if the query returned any results
if [ -z "$FORMATTED_TARGETS" ]; then
	echo "No targets found. Something went wrong with the query."
	exit 1
fi

# Replace the entire ngrok_image_targets array
cat >"$IMAGES_FILE" <<EOF
"""
This file is generated by scripts/generate_load_images.sh
Do not edit this file directly. Instead, run 'bazel run //:generate_load_images.sh' to regenerate it.
"""

image_targets = [
$FORMATTED_TARGETS
]
EOF
