set -euo pipefail

export PATH="$(git rev-parse --show-toplevel)/bin:$PATH"
_u=https://github.com/bazelbuild/bazelisk/releases/download/v1.27.0/bazelisk-

# for os in linux darwin; do
#    for arch in amd64 arm64; do
#        hash=$(direnv fetchurl "${_u}$os-$arch")
#        echo -e "$os-$arch\t$hash"
#    done
# done

case "$(uname | tr A-Z a-z)-$(uname -m)" in
    linux-x86_64)
        bzl=$(direnv fetchurl "${_u}linux-amd64" sha256-4VCDI/NHrRRlqIe8XSv7kc/8Iy0R6OmXtiMifGsy+3Y=);;
    linux-aarch64)
        bzl=$(direnv fetchurl "${_u}linux-arm64" sha256-u2CFGaRA1F0QME62hKc6K2u3aZxbDlQ0NhZhsl8ROl0=);;
    darwin-x86_64)
        bzl=$(direnv fetchurl "${_u}darwin-amd64" sha256-j817qCj2c7pLFSlCXgHhWsQlme9WbBfzINjL/nuWoWc=);;
    darwin-aarch64)
        bzl=$(direnv fetchurl "${_u}darwin-arm64" sha256-i/CMiUzMGe838oblgYTDlCxYywjalV6ZBSJwNSbdtyA=);;
    *)
        >&2 echo "unsupported architecture tuple $(uname | tr A-Z a-z)-$(uname -m)"
        exit 1;;
esac

ln -sf "${bzl}" bin/bazel

watch_file bazel-out/bazel_env-opt/bin/tools/bazel_env/bin
PATH_add bazel-out/bazel_env-opt/bin/tools/bazel_env/bin
if [[ ! -d bazel-out/bazel_env-opt/bin/tools/bazel_env/bin ]]; then
    log_error "ERROR[bazel_env.bzl]: Run 'bazel run //tools:bazel_env' to regenerate bazel-out/bazel_env-opt/bin/tools/bazel_env/bin"
fi
