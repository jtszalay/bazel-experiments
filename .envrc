#!/usr/bin/env bash
# ^^^ make IDEs happy

set -euo pipefail

PATH_add bin
_u=https://github.com/bazelbuild/bazelisk/releases/download/v1.27.0/bazelisk-

if [[ "${PRINT_TOOL_HASHES:-no}" = "yes" ]]; then
    for os in linux darwin; do
        for arch in amd64 arm64; do
            hash_bzl=$(direnv fetchurl "${_u}$os-$arch")
            echo -e "bzl:  $os-$arch\t$hash_bzl"
        done
    done
fi

# to fetch the hashes, run:
# $ PRINT_TOOL_HASHES=yes bash .envrc
case "$(uname | tr A-Z a-z)-$(uname -m)" in
    linux-x86_64)
        bzl=$(direnv fetchurl "${_u}linux-amd64" sha256-4VCDI/NHrRRlqIe8XSv7kc/8Iy0R6OmXtiMifGsy+3Y=);;
    linux-aarch64)
        bzl=$(direnv fetchurl "${_u}linux-arm64" sha256-u2CFGaRA1F0QME62hKc6K2u3aZxbDlQ0NhZhsl8ROl0=);;
    darwin-x86_64)
        bzl=$(direnv fetchurl "${_u}darwin-amd64" sha256-j817qCj2c7pLFSlCXgHhWsQlme9WbBfzINjL/nuWoWc=);;
    darwin-aarch64)
        bzl=$(direnv fetchurl "${_u}darwin-arm64" sha256-i/CMiUzMGe838oblgYTDlCxYywjalV6ZBSJwNSbdtyA=);;
    darwin-arm64)
        bzl=$(direnv fetchurl "${_u}darwin-arm64" sha256-i/CMiUzMGe838oblgYTDlCxYywjalV6ZBSJwNSbdtyA=);;
    *)
        >&2 echo "unsupported architecture tuple $(uname | tr A-Z a-z)-$(uname -m)"
        exit 1;;
esac

ln -sf "${bzl}" bin/bazel

export BAZEL_ENV_BIN_DIR="$(bazel info output_path 2>/dev/null)/bazel_env-opt/bin/tools/bazel_env/bin"
watch_file "$BAZEL_ENV_BIN_DIR"
PATH_add "$BAZEL_ENV_BIN_DIR"
if [[ ! -d "$BAZEL_ENV_BIN_DIR" ]]; then
  log_error "ERROR: Run 'bazel run //tools:bazel_env' to regenerate $BAZEL_ENV_BIN_DIR"
fi
